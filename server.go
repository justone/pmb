package main

import (
	"github.com/justone/pmb/api"

	"fmt"
)

type ServerCommand struct {
	Name string `short:"n" long:"name" description:"Name of this server." default:"autogenerated"`
}

var serverCommand ServerCommand

func (x *ServerCommand) Execute(args []string) error {
	bus := pmb.GetPMB()

	conn, err := bus.GetConnection(globalOptions.URI, "server")
	if err != nil {
		return err
	} else {
		return runServer(conn)
	}
}

func init() {
	parser.AddCommand("server",
		"Run the local server agent.",
		"",
		&serverCommand)
}

func runServer(conn *pmb.Connection) error {
	for {
		message := <-conn.In

		fmt.Println("Message received: ", message.Contents)

		// send it back
		conn.Out <- message
	}

	return nil
}
